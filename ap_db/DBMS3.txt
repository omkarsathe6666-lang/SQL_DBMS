-- ******************************************************
-- Problem Statement: 03
-- SQL Queries using Joins, Subqueries, and Views
-- ******************************************************

-- Drop existing tables (ignore errors if not exist)
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE Manages CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE Works CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE Company CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE Employee CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

------------------------------------------------------------
-- 1. CREATE TABLES WITH CONSTRAINTS
------------------------------------------------------------

CREATE TABLE Employee (
    employee_name VARCHAR2(30) PRIMARY KEY,
    street VARCHAR2(30) NOT NULL,
    city VARCHAR2(30)
);

CREATE TABLE Company (
    company_name VARCHAR2(40) PRIMARY KEY,
    city VARCHAR2(30) NOT NULL
);

CREATE TABLE Works (
    employee_name VARCHAR2(30),
    company_name VARCHAR2(40),
    salary NUMBER(10,2) CHECK (salary > 0),
    PRIMARY KEY (employee_name, company_name),
    FOREIGN KEY (employee_name) REFERENCES Employee(employee_name),
    FOREIGN KEY (company_name) REFERENCES Company(company_name)
);

CREATE TABLE Manages (
    employee_name VARCHAR2(30),
    manager_name VARCHAR2(30),
    PRIMARY KEY (employee_name, manager_name),
    FOREIGN KEY (employee_name) REFERENCES Employee(employee_name)
);

------------------------------------------------------------
-- 2. INSERT SAMPLE DATA
------------------------------------------------------------

-- Employee records
INSERT INTO Employee VALUES ('Ravi', 'MG Road', 'Pune');
INSERT INTO Employee VALUES ('Asmita', 'Main Street', 'Lonavala');
INSERT INTO Employee VALUES ('Neha', 'Hill Road', 'Mumbai');
INSERT INTO Employee VALUES ('Rohan', 'Camp Area', 'Pune');
INSERT INTO Employee VALUES ('Pooja', 'FC Road', 'Nashik');
INSERT INTO Employee VALUES ('Gaurav', 'Lake View', 'Nagpur');
INSERT INTO Employee VALUES ('Sneha', 'Central Park', 'Gotham');

-- Company records
INSERT INTO Company VALUES ('First Bank Corporation', 'Mumbai');
INSERT INTO Company VALUES ('Small Bank Corporation', 'Pune');
INSERT INTO Company VALUES ('Tech Solutions', 'Nashik');
INSERT INTO Company VALUES ('DataSoft', 'Gotham');

-- Works records
INSERT INTO Works VALUES ('Ravi', 'First Bank Corporation', 12000);
INSERT INTO Works VALUES ('Asmita', 'First Bank Corporation', 9500);
INSERT INTO Works VALUES ('Neha', 'Small Bank Corporation', 8000);
INSERT INTO Works VALUES ('Rohan', 'Small Bank Corporation', 7500);
INSERT INTO Works VALUES ('Pooja', 'Tech Solutions', 15000);
INSERT INTO Works VALUES ('Gaurav', 'DataSoft', 11000);
INSERT INTO Works VALUES ('Sneha', 'DataSoft', 9500);

-- Manages records
INSERT INTO Manages VALUES ('Ravi', 'Asmita');
INSERT INTO Manages VALUES ('Neha', 'Rohan');
INSERT INTO Manages VALUES ('Pooja', 'Gaurav');

COMMIT;

------------------------------------------------------------
-- 3. SQL QUERIES
------------------------------------------------------------

-- 1) Names of employees who work for First Bank Corporation
SELECT employee_name
FROM Works
WHERE company_name = 'First Bank Corporation';

-- 2) Names and cities of employees who work for First Bank Corporation
SELECT e.employee_name, e.city
FROM Employee e
JOIN Works w ON e.employee_name = w.employee_name
WHERE w.company_name = 'First Bank Corporation';

-- 3) Names, street, and cities of employees of First Bank Corporation earning > 10000
SELECT e.employee_name, e.street, e.city
FROM Employee e
JOIN Works w ON e.employee_name = w.employee_name
WHERE w.company_name = 'First Bank Corporation' AND w.salary > 10000;

-- 4) Employees who earn more than each employee of Small Bank Corporation
SELECT employee_name
FROM Works
WHERE salary > ALL (SELECT salary FROM Works WHERE company_name = 'Small Bank Corporation');

-- 5) Employees earning more than the average salary of their company
SELECT w.employee_name, w.company_name, w.salary
FROM Works w
WHERE w.salary > (
    SELECT AVG(w2.salary)
    FROM Works w2
    WHERE w2.company_name = w.company_name
);

-- 6) Company with the smallest payroll (total salary)
SELECT company_name
FROM Works
GROUP BY company_name
HAVING SUM(salary) = (
    SELECT MIN(SUM(salary))
    FROM Works
    GROUP BY company_name
);

-- 7) Companies whose employees earn higher average salary than First Bank Corporation
SELECT company_name
FROM Works
GROUP BY company_name
HAVING AVG(salary) > (
    SELECT AVG(salary)
    FROM Works
    WHERE company_name = 'First Bank Corporation'
);

-- 8) Give all employees of First Bank Corporation a 10% raise
UPDATE Works
SET salary = salary * 1.10
WHERE company_name = 'First Bank Corporation';

-- 9) Create table HighEarners and insert employees who earn more than the average salary
CREATE TABLE HighEarners (
    employee_name VARCHAR2(30),
    salary NUMBER(10,2)
);

INSERT INTO HighEarners
SELECT employee_name, salary
FROM Works
WHERE salary > (SELECT AVG(salary) FROM Works);

-- 10) Delete employees who work for companies located in Gotham
DELETE FROM Employee
WHERE employee_name IN (
    SELECT w.employee_name
    FROM Works w
    JOIN Company c ON w.company_name = c.company_name
    WHERE c.city = 'Gotham'
);

------------------------------------------------------------
-- 4. CREATE VIEW
------------------------------------------------------------

CREATE VIEW EmpCompanyView AS
SELECT e.employee_name, e.city AS emp_city, w.company_name, w.salary, c.city AS comp_city
FROM Employee e
JOIN Works w ON e.employee_name = w.employee_name
JOIN Company c ON w.company_name = c.company_name;

-- Display the view
SELECT * FROM EmpCompanyView;

COMMIT;
